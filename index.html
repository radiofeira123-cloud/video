<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vídeo Zoom-Out Mosaico 4K</title>
<style>
  :root{--bg:#0f1724;--accent:#06b6d4;--muted:#94a3b8;color-scheme:dark}
  body{margin:0;min-height:100vh;background:linear-gradient(180deg,#071025,#0f1724);color:#e6eef6;font-family:Inter,system-ui,Arial;display:flex;align-items:center;justify-content:center;padding:20px}
  .card{background:rgba(255,255,255,0.05);padding:20px;border-radius:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);max-width:900px;width:100%}
  h1{font-size:20px;margin:0 0 10px 0;text-align:center}
  p{font-size:14px;color:var(--muted);text-align:center;margin-bottom:20px}
  input[type=file]{display:none}
  .btn{background:linear-gradient(90deg,var(--accent),#7c3aed);border:none;padding:10px 18px;border-radius:10px;color:#021124;cursor:pointer;font-weight:600;display:inline-block;margin-bottom:10px}
  #canvas{display:block;margin:10px auto;background:#000;border-radius:10px;max-width:100%}
  #log{font-family:monospace;font-size:13px;color:var(--muted);height:120px;overflow:auto;padding:8px;background:rgba(255,255,255,0.02);border-radius:8px}
  .small{text-align:center;font-size:13px;color:var(--muted)}
</style>
</head>
<body>
<div class="card">
  <h1>Gerador de Vídeo Zoom-Out 4K</h1>
  <p>Envie suas fotos. O vídeo começa com uma foto aleatória central e vai zoom-out até mostrar todas em mosaico 4K horizontal.</p>
  <div style="text-align:center">
    <label for="files" class="btn">Selecionar Fotos</label>
    <input id="files" type="file" accept="image/*" multiple>
    <button id="generate" class="btn">Gerar Vídeo (WebM)</button>
  </div>
  <canvas id="canvas" width="3840" height="2160"></canvas>
  <div id="log"></div>
  <p class="small">O vídeo será exportado em WebM, que pode ser convertido para MP4 localmente com FFmpeg.</p>
</div>
<script>
const filesInput = document.getElementById('files');
const generateBtn = document.getElementById('generate');
const canvas = document.getElementById('canvas');
const logEl = document.getElementById('log');
let images = [];

function log(msg){ logEl.textContent += msg + '\n'; logEl.scrollTop = logEl.scrollHeight; }
function clearLog(){ logEl.textContent = ''; }

filesInput.addEventListener('change', async (ev)=>{
  clearLog();
  const list = Array.from(ev.target.files).filter(f=>f.type.startsWith('image/'));
  log('Carregando ' + list.length + ' imagens...');
  images = [];
  for(const f of list){
    const url = URL.createObjectURL(f);
    const img = await loadImage(url);
    images.push(img);
  }
  log('Todas as imagens carregadas ('+images.length+')');
});

function loadImage(src){
  return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; i.crossOrigin='anonymous'; });
}

generateBtn.addEventListener('click', async()=>{
  if(images.length===0){ alert('Selecione as fotos primeiro.'); return; }
  generateBtn.disabled = true;
  clearLog();
  log('Gerando vídeo zoom-out com ' + images.length + ' fotos...');

  const width = 3840, height = 2160, fps = 30, duration = 20;
  canvas.width = width; canvas.height = height;
  const ctx = canvas.getContext('2d');
  const totalFrames = duration * fps;

  const cols = Math.ceil(Math.sqrt(images.length));
  const rows = Math.ceil(images.length / cols);
  const cellW = width / cols;
  const cellH = height / rows;

  const bigCanvas = document.createElement('canvas');
  bigCanvas.width = cols * cellW;
  bigCanvas.height = rows * cellH;
  const bctx = bigCanvas.getContext('2d');

  // Escolhe foto central aleatória
  const centralIndex = Math.floor(Math.random() * images.length);
  const centralImage = images[centralIndex];
  const others = images.slice();
  others.splice(centralIndex,1);
  const orderedImages = [centralImage, ...others];

  // Posiciona foto central no meio do mosaico
  const centerCol = Math.floor(cols/2);
  const centerRow = Math.floor(rows/2);
  orderedImages.forEach((img,i)=>{
    let c, r;
    if(i===0){ c=centerCol; r=centerRow; }
    else{ const idx = i-1; c = idx % cols; r = Math.floor(idx/cols); if(c===centerCol && r===centerRow){ c++; } }
    bctx.drawImage(img, c*cellW, r*cellH, cellW, cellH);
  });

  const stream = canvas.captureStream(fps);
  const recorder = new MediaRecorder(stream, {mimeType:'video/webm;codecs=vp9'});
  const chunks=[];
  recorder.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
  recorder.onstop = ()=>{
    const blob = new Blob(chunks,{type:'video/webm'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='zoomout_4k.webm'; a.click();
    log('Vídeo WebM pronto!');
  };
  recorder.start();

  for(let f=0; f<totalFrames; f++){
    const t = f/totalFrames;
    const zoom = 1 / (1 + 4*t);
    const cx = centerCol*cellW + cellW/2;
    const cy = centerRow*cellH + cellH/2;
    const viewW = width * zoom;
    const viewH = height * zoom;

    ctx.fillStyle='#000'; ctx.fillRect(0,0,width,height);
    ctx.drawImage(bigCanvas, cx - viewW/2, cy - viewH/2, viewW, viewH, 0, 0, width, height);
    await wait(1000/fps);
  }

  recorder.stop();
  generateBtn.disabled = false;
});

function wait(ms){ return new Promise(r=>setTimeout(r, ms)); }
</script>
</body>
</html>
